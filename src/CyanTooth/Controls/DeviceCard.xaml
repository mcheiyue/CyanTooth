<UserControl x:Class="BluetoothManager.Controls.DeviceCard"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:vm="clr-namespace:BluetoothManager.ViewModels"
             xmlns:converters="clr-namespace:BluetoothManager.Converters"
             mc:Ignorable="d"
             d:DesignHeight="80" d:DesignWidth="350">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:ConnectionTooltipConverter x:Key="ConnectionTooltipConverter"/>
        
        <Style x:Key="ConnectedIndicatorStyle" TargetType="Ellipse">
            <Setter Property="Width" Value="8"/>
            <Setter Property="Height" Value="8"/>
            <Setter Property="Fill" Value="{DynamicResource SystemFillColorSuccessBrush}"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsConnected}" Value="False">
                    <Setter Property="Fill" Value="{DynamicResource TextFillColorDisabledBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="BatteryTextStyle" TargetType="TextBlock">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsLowBattery}" Value="True">
                    <Setter Property="Foreground" Value="{DynamicResource SystemFillColorCautionBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
           BorderBrush="{DynamicResource ControlElevationBorderBrush}"
           BorderThickness="1"
           CornerRadius="8"
           Padding="12"
           Margin="0,4"
           Cursor="Hand"
           MouseLeftButtonDown="Card_MouseLeftButtonDown">
        
        <Border.Style>
            <Style TargetType="Border">
                <Style.Triggers>
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}"/>
                    </Trigger>
                    <DataTrigger Binding="{Binding IsConnected}" Value="True">
                        <Setter Property="BorderBrush" Value="{DynamicResource AccentFillColorDefaultBrush}"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </Border.Style>

        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Device Icon -->
            <Grid Grid.Column="0" Width="48" Height="48" Margin="0,0,12,0">
                <Ellipse Fill="{DynamicResource ControlFillColorSecondaryBrush}"/>
                <TextBlock Text="{Binding DeviceIcon}" 
                          FontFamily="Segoe Fluent Icons, Segoe MDL2 Assets"
                          FontSize="20"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"/>
                
                <!-- Connection indicator -->
                <Ellipse Style="{StaticResource ConnectedIndicatorStyle}"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Bottom"
                        Margin="0,0,2,2"/>
            </Grid>

            <!-- Device Info -->
            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBlock Grid.Column="0" 
                              Text="{Binding Name}" 
                              FontSize="14" 
                              FontWeight="Medium"
                              TextTrimming="CharacterEllipsis"/>
                    
                    <!-- Favorite star -->
                    <ui:SymbolIcon Grid.Column="1" 
                                  Symbol="Star24" 
                                  Foreground="{DynamicResource SystemFillColorAttentionBrush}"
                                  Visibility="{Binding IsFavorite, Converter={StaticResource BoolToVis}}"
                                  Margin="4,0,0,0"
                                  FontSize="12"/>
                </Grid>
                
                <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                    <TextBlock Text="{Binding StatusText}" 
                              FontSize="12"
                              Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                    
                    <!-- Battery info -->
                    <StackPanel Orientation="Horizontal" 
                               Margin="12,0,0,0"
                               Visibility="{Binding HasBattery, Converter={StaticResource BoolToVis}}">
                        <TextBlock Text="{Binding BatteryIcon}" 
                                  FontFamily="Segoe Fluent Icons, Segoe MDL2 Assets"
                                  FontSize="12"
                                  Style="{StaticResource BatteryTextStyle}"/>
                        <TextBlock Text="{Binding BatteryText}" 
                                  FontSize="12"
                                  Margin="4,0,0,0"
                                  Style="{StaticResource BatteryTextStyle}"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>

            <!-- Connect/Disconnect Button -->
            <ui:Button Grid.Column="2"
                      Appearance="Transparent"
                      Padding="8"
                      Margin="8,0"
                      ToolTip="{Binding IsConnected, Converter={StaticResource ConnectionTooltipConverter}}"
                      Command="{Binding ConnectCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      CommandParameter="{Binding}"
                      IsEnabled="{Binding IsAudioDevice}"
                      Visibility="{Binding IsAudioDevice, Converter={StaticResource BoolToVis}}">
                <ui:Button.Content>
                    <ui:SymbolIcon>
                        <ui:SymbolIcon.Style>
                            <Style TargetType="ui:SymbolIcon">
                                <Setter Property="Symbol" Value="PlugConnected24"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsConnected}" Value="True">
                                        <Setter Property="Symbol" Value="PlugDisconnected24"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ui:SymbolIcon.Style>
                    </ui:SymbolIcon>
                </ui:Button.Content>
            </ui:Button>

            <!-- More Options Menu -->
            <ui:Button Grid.Column="3"
                      Appearance="Transparent"
                      Padding="8"
                      ToolTip="更多选项"
                      Click="MoreOptions_Click">
                <ui:Button.Content>
                    <ui:SymbolIcon Symbol="MoreVertical24"/>
                </ui:Button.Content>
            </ui:Button>
        </Grid>

        <!-- Loading Overlay -->
        <Border.Effect>
            <DropShadowEffect ShadowDepth="0" 
                             BlurRadius="0"
                             Opacity="0"/>
        </Border.Effect>
    </Border>
</UserControl>
