name: Release

permissions:
  contents: write

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g. v1.0.2)'
        required: true
        default: 'v1.0.2'
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-release:
    name: Build Release
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Extract Version
      id: get_version
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          echo "clean_version=${{ github.event.inputs.version }}" | sed 's/^v//' >> $GITHUB_ENV
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          echo "clean_version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
        fi

    # 1. 轻量版 (Framework-dependent)
    # 不使用 SingleFile，而是普通的 Publish，以保留 runtimeconfig.json，并打成 Zip
    - name: Publish Lightweight (Zip)
      run: |
        dotnet publish src/CyanTooth/CyanTooth.csproj -c Release -r win-${{ matrix.arch }} --self-contained false -p:Version=${{ env.clean_version }} -o ./publish_lightweight
        Compress-Archive -Path ./publish_lightweight/* -DestinationPath ./CyanTooth-win-${{ matrix.arch }}-lightweight.zip

    # 2. 独立版 (Self-contained SingleFile)
    # 开启 R2R (ReadyToRun) 可能导致体积变大，这里权衡后暂不开启 R2R 以减小体积，或者仅使用 Trim (如果不影响反射)
    # 这里保持稳妥：SelfContained=true, SingleFile=true, EnableCompressionInSingleFile=true (压缩体积)
    - name: Publish Standalone (SingleFile)
      run: |
        dotnet publish src/CyanTooth/CyanTooth.csproj -c Release -r win-${{ matrix.arch }} --self-contained true -p:PublishSingleFile=true -p:EnableCompressionInSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:Version=${{ env.clean_version }} -o ./publish_standalone
        move publish_standalone\CyanTooth.exe CyanTooth-win-${{ matrix.arch }}-standalone.exe

    - name: Generate Changelog
      if: matrix.arch == 'x64'
      id: changelog
      shell: bash
      # Use UTF-8 for Chinese characters in logs
      run: |
        export PYTHONIOENCODING=utf-8
        echo "## 变更日志 / Changelog" > release_notes.md
        echo "" >> release_notes.md
        
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
           # First release
           git log --pretty=format:"- %s (%h)" >> release_notes.md
        else
           # Incremental log
           git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> release_notes.md
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          CyanTooth-win-${{ matrix.arch }}-lightweight.zip
          CyanTooth-win-${{ matrix.arch }}-standalone.exe
        body_path: ${{ matrix.arch == 'x64' && 'release_notes.md' || '' }}
        generate_release_notes: ${{ matrix.arch == 'x64' }}
        draft: false
        prerelease: false
