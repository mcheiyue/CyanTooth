name: CD - Release Build

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: å®‰è£… .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      shell: bash
    
    # 1. æ„å»ºè½»é‡ç‰ˆ (Framework-dependent)
    - name: æ„å»º x64 è½»é‡ç‰ˆ (éœ€è¦ .NET 8)
      run: |
        dotnet publish src/BluetoothManager/BluetoothManager.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained false `
          -p:PublishSingleFile=true `
          --output ./publish/lightweight/win-x64
    
    - name: æ„å»º ARM64 è½»é‡ç‰ˆ (éœ€è¦ .NET 8)
      run: |
        dotnet publish src/BluetoothManager/BluetoothManager.csproj `
          --configuration Release `
          --runtime win-arm64 `
          --self-contained false `
          -p:PublishSingleFile=true `
          --output ./publish/lightweight/win-arm64

    # 2. æ„å»ºå®Œæ•´ç‰ˆ (Self-contained + Compressed)
    - name: æ„å»º x64 å®Œæ•´ç‰ˆ (æ— éœ€ .NET)
      run: |
        dotnet publish src/BluetoothManager/BluetoothManager.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:EnableCompressionInSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:PublishReadyToRun=true `
          --output ./publish/standalone/win-x64
    
    - name: æ„å»º ARM64 å®Œæ•´ç‰ˆ (æ— éœ€ .NET)
      run: |
        dotnet publish src/BluetoothManager/BluetoothManager.csproj `
          --configuration Release `
          --runtime win-arm64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:EnableCompressionInSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          --output ./publish/standalone/win-arm64

    # 3. é‡å‘½åæ–‡ä»¶
    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir release-assets
        # è½»é‡ç‰ˆ
        copy .\publish\lightweight\win-x64\BluetoothManager.exe .\release-assets\CyanTooth-x64.exe
        copy .\publish\lightweight\win-arm64\BluetoothManager.exe .\release-assets\CyanTooth-arm64.exe
        # å®Œæ•´ç‰ˆ
        copy .\publish\standalone\win-x64\BluetoothManager.exe .\release-assets\CyanTooth-x64-standalone.exe
        copy .\publish\standalone\win-arm64\BluetoothManager.exe .\release-assets\CyanTooth-arm64-standalone.exe
      shell: cmd
    
    # 4. åˆ›å»º GitHub Release
    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release-assets/*.exe
        body: |
          ## ğŸ‰ CyanTooth ${{ steps.get_version.outputs.VERSION }}
          
          ### ğŸ“¦ ä¸‹è½½é€‰é¡¹
          
          #### ğŸ”¹ æ¨èç‰ˆæœ¬ (ä½“ç§¯å°ï¼Œéœ€å®‰è£… .NET 8)
          - **x64**: `CyanTooth-x64.exe` (~38 MB)
          - **ARM64**: `CyanTooth-arm64.exe`
          
          #### ğŸ”¸ ç‹¬ç«‹ç‰ˆæœ¬ (ä½“ç§¯è¾ƒå¤§ï¼Œæ— éœ€é…ç½®)
          - **x64**: `CyanTooth-x64-standalone.exe` (~75 MB)
          - **ARM64**: `CyanTooth-arm64-standalone.exe`
          
          ### âœ¨ æ›´æ–°å†…å®¹
          è¯·æŸ¥çœ‹æäº¤å†å²äº†è§£è¯¦ç»†å˜æ›´ã€‚
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
